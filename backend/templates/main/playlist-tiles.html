<!-- templates/app/playlist_tiles.html -->

{% extends 'base.html' %} 

{% block header %}
<style>
    .tile-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        padding: 20px 0; 
    }

    .tile-item {
        border: none;
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.2s;
        text-align: center;
    }

    .tile-item img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        display: block;
    }

    .album-image {
        background: var(--bg-sidebar);
        background-size: cover;
        background-color: var(--bg-main); 
        background: linear-gradient(-45deg, #fcce, #8868, #3340), 
                    linear-gradient(-135deg, #cfce, #8668, #4430), 
                    linear-gradient(-225deg, #ccfe, #6868, #3340), 
                    linear-gradient(-315deg, #ffce, #6688, #3430) 
                    !important;
    }

    .tile-info {
        padding-left: 15px;
        padding-right: 15px;
        padding-bottom: 10px;
        background-color: var(--bg-content);
    }

    .tile-info p {
        margin: 0;
        color: var(--tile-info-text);
        font-size: 0.9em;
    }

    h3.playlist-name {
        margin: 0 0 5px 0;
        font-size: 16px !important;   
        padding-bottom: 8px;
        height: 18px;
        text-align: left;
        padding-left: 14px;
        overflow: hidden;
    }

    .playlist-genres,
    .playlist-artists {
        color: var(--bg-sidebar);
        text-align: left;
    }

    .new-list{
        margin-top: 16px;
        width: 90%;
    }
    #new-list-name {
        width: 75%;
    }
    #new-list-send {
        color: var(--bg-main);
        
    }

    /* Estilo para ocultar el formulario por defecto */
    #new-list {
        display: none; 
    }
    
    .new-list-toggle {
        /* Estilo para el botón flotante o fijo que abre el form */
        /* Puedes ajustarlo a tu diseño (p. ej., un botón + en la esquina superior derecha) */
        cursor: pointer;
        padding: 5px 10px;
        background-color: var(--bg-sidebar);
        color: var(--bg-main) !important;
        border-radius: 5px;
        position: absolute;
        right: 16px;
        top: 16px;
    }

</style>
   
 <script>
        let nextPage = 1;
        let isLoading = false;
        let playlistCount = 0;
        let currentSearchTerm = '-';

        function truncate(artist, n){
            return  (artist.split(', ').length == 2) ? artist.replace(', ', ' / ') : 
                    (artist.split(', ').length  > n) ? 'Various Artists'           : 
                    artist;
        };
        
        function loadPlaylists() {
            if (isLoading) return;
            isLoading = true;
            loadingIndicator.style.display = 'block';

            const url = new URL(`{% url 'playlist-list' %}`, window.location.origin);
            url.searchParams.set('page', nextPage);
            if (currentSearchTerm) {
                url.searchParams.set('search', currentSearchTerm);
            }

            fetch(url.toString(), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.playlists.length > 0) {
                    data.playlists.forEach(playlist => {
                        const div = document.createElement('div');
                        div.className = "tile-item playlist-item";
                        div.setAttribute('data-playlist-artist', playlist.safeartist); 
                        div.setAttribute('data-playlist-name', playlist.safename);
                        
                        div.innerHTML = `
                            <a href="${playlist.url_detalle}"> 
                                <div class="album-art">
                                    <div class="album-image" style="background-image: url('${playlist.url_picture ? playlist.url_picture : ''}')" alt="Playlist cover"></div>
                                </div>
                                <div class="tile-info">
                                    <h3 class="playlist-name">${playlist.nombre}</h3>
                                    <h6 class="playlist-artists">${truncate(playlist.artists, 3)}</h6>
                                    <h6 class="playlist-genres">${truncate(playlist.genres, 3)}</h6>
                                </div>
                            </a>
                        `;
                        container.appendChild(div);
                    });
                    nextPage++;
                    isLoading = false;
                    // Actualizamos el contador total si la respuesta lo incluye
                    if (data.total_count !== undefined) {
                         playlistCount = data.total_count;
                         countDisplay.textContent = playlistCount;
                    }
                } else {
                    scrollbox.removeEventListener('scroll', handleScroll);
                }
                loadingIndicator.style.display = 'none';
            })
            .catch(error => {
                console.error('Error fetching playlists:', error);
                isLoading = false;
                loadingIndicator.style.display = 'none';
            });
        }
        
        function handleScroll() {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            if (scrollTop + clientHeight >= scrollHeight - 200) {
                loadPlaylists();
            }
        }

        function triggerSearch() {
            const newSearchTerm = searchInput.value.toLowerCase().trim();
            
            if (newSearchTerm !== currentSearchTerm) {
                // Reiniciar el estado para una nueva búsqueda
                currentSearchTerm = newSearchTerm;
                nextPage = 1;
                playlistCount = 0;
                container.innerHTML = ''; // Limpiar álbumes anteriores
                scrollbox.addEventListener('scroll', handleScroll); // Asegurarse de que el scroll listener esté activo
                loadPlaylists(); // Cargar la primera página de los resultados de la búsqueda
            }
        }

        function toggleNewListForm() {
            const form = document.getElementById('new-list');
            // Muestra u oculta el formulario
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'flex'; // o 'block', dependiendo de tus estilos 'new-list'
                document.getElementById('new-list-name').focus();
            } else {
                form.style.display = 'none';
                document.getElementById('new-list-name').value = ''; // Limpia el input al ocultar
            }
        }
        // function createPlaylist() {
        //     const playlistNameInput = document.getElementById('new-list-name');
        //     const playlistName = playlistNameInput.value.trim();

        //     if (!playlistName) {
        //         alert("Por favor, introduce un nombre para la lista.");
        //         return;
        //     }

        //     // Enviar datos al endpoint de Django usando AJAX POST
        //     fetch('{% url "create-playlist" %}', { // Usaremos este nombre de URL en urls.py
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json',
        //             // Importante: Necesitas el CSRF token para peticiones POST en Django
        //             'X-CSRFToken': getCookie('csrftoken'), 
        //             'X-Requested-With': 'XMLHttpRequest'
        //         },
        //         body: JSON.stringify({ name: playlistName })
        //     })
        //     .then(response => response.json())
        //     .then(data => {
        //         if (data.status === 'success') {
        //             //alert(`Lista "${playlistName}" creada con éxito.`);
        //             toggleNewListForm(); // Oculta el formulario después del éxito
                    
        //             // Opcional: Reiniciar la vista para mostrar la nueva lista inmediatamente
        //             // Esto recargará todos los tiles desde el backend
        //             currentSearchTerm = ''; // Reseteamos el término de búsqueda si es necesario
        //             nextPage = 1;
        //             container.innerHTML = '';
        //             loadPlaylists(); 

        //         } else if (data.status === 'login') {
        //             window.location = '/accounts/login/?next=/';
        //         } else {
        //             alert('Error al crear la playlist: ' + data.message);
        //         }
        //     })
        //     .catch(error => {
        //         console.error('Fetch error:', error);
        //         alert('Ocurrió un error de red o del servidor.');
        //     });
        // }
        
        // Función auxiliar para obtener el CSRF token de las cookies (necesario para POST)
        
</script>
{% endblock %}

{% block search %}
    <input type="text" id="searchInput" class="searchInput" placeholder="Filtrar álbumes...">
{% endblock %}

{% block content-title %}Listas (<span id="playlist-count">{{ playlists.count }}</span>)<button type="button" onclick="toggleNewListForm()" style="border-radius: 24px" class="input new-list-toggle confirm">+</button>{% endblock %}


{% block content %}

<div id="loading" style="display: none;">Cargando playlists...</div>

<div class="new-list" id="new-list">
    <input type="text" id="new-list-name" placeholder="Nombre de la lista" />
    <button type="button" id="new-list-send" class="input confirm" title="Añadir nueva lista" onclick="playlistmanager.createPlaylist()">+</button>
    <button type="button" id="new-list-cancel" class="input" title="Cancelar" onclick="toggleNewListForm()">X</button>
</div>    

<div class="tile-container" id="tileContainer"></div>

<script>
    const container         = document.getElementById('tileContainer');
    const scrollbox         = document.getElementsByClassName('main-content')[0];
    const loadingIndicator  = document.getElementById('loading');
    const countDisplay      = document.getElementById('playlist-count');
    const searchInput       = document.getElementById('searchInput'); 

    window.addEventListener('DOMContentLoaded', (event) => {
        scrollbox.addEventListener('scroll', handleScroll);
        
        searchInput.addEventListener('input', () => {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(triggerSearch, 300);
        });

        triggerSearch(); 
    });
</script>

{% endblock %}
