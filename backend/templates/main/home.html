<!-- templates/app/home.html -->

{% extends 'base.html' %} 
{% load fontawesome_5 %}
{% block header %}
<style>
   
</style>
   
 <script>
        let nextPage = 1;
        let isLoading = false;
        let playlistCount = 0;
        let currentSearchTerm = '-';

        function truncate(artist, n){
            return  (artist.split(', ').length == 2) ? artist.replace(', ', ' / ') : 
                    (artist.split(', ').length  > n) ? 'Various Artists'           : 
                    artist;
        };
        
        function loadPlaylists() {
            if (isLoading) return;
            isLoading = true;
            loadingIndicator.style.display = 'block';

            const url = new URL(`{% url 'playlist-list' %}`, window.location.origin);
            url.searchParams.set('page', nextPage);
            if (currentSearchTerm) {
                url.searchParams.set('search', currentSearchTerm);
            }

            fetch(url.toString(), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.playlists.length > 0) {
                    data.playlists.forEach(playlist => {
                        const div = document.createElement('div');
                        div.className = "tile-item playlist-item";
                        div.setAttribute('data-playlist-artist', playlist.safeartist); 
                        div.setAttribute('data-playlist-name', playlist.safename);
                        
                        div.innerHTML = `
                            <a href="${playlist.url_detalle}"> 
                                <div class="album-art">
                                    <div class="album-image" style="background-image: url('${playlist.url_picture ? playlist.url_picture : ''}')" alt="Playlist cover"></div>
                                </div>
                                <div class="tile-info">
                                    <h3 class="playlist-name">${playlist.nombre}</h3>
                                    <h6 class="playlist-artists">${truncate(playlist.artists, 3)}</h6>
                                    <h6 class="playlist-genres">${truncate(playlist.genres, 3)}</h6>
                                </div>
                            </a>
                        `;
                        container.appendChild(div);
                    });
                    nextPage++;
                    isLoading = false;
                    // Actualizamos el contador total si la respuesta lo incluye
                    try {
                        if (data.total_count !== undefined) {
                         playlistCount = data.total_count;
                         countDisplay.textContent = playlistCount;
                        }
                    } catch(e){

                    }
                } else {
                    scrollbox.removeEventListener('scroll', handleScroll);
                }
                loadingIndicator.style.display = 'none';
            })
            .catch(error => {
                console.error('Error fetching playlists:', error);
                isLoading = false;
                loadingIndicator.style.display = 'none';
            });
        }
        
        function handleScroll() {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            if (scrollTop + clientHeight >= scrollHeight - 200) {
                loadPlaylists();
            }
        }

        function triggerSearch() {
            const newSearchTerm = searchInput.value.toLowerCase().trim();
            
            if (newSearchTerm !== currentSearchTerm) {
                // Reiniciar el estado para una nueva búsqueda
                currentSearchTerm = newSearchTerm;
                nextPage = 1;
                playlistCount = 0;
                container.innerHTML = ''; // Limpiar álbumes anteriores
                scrollbox.addEventListener('scroll', handleScroll); // Asegurarse de que el scroll listener esté activo
                loadPlaylists(); // Cargar la primera página de los resultados de la búsqueda
            }
        }

        function toggleNewListForm() {
            const form = document.getElementById('new-list');
            // Muestra u oculta el formulario
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'flex'; // o 'block', dependiendo de tus estilos 'new-list'
                document.getElementById('new-list-name').focus();
            } else {
                form.style.display = 'none';
                document.getElementById('new-list-name').value = ''; // Limpia el input al ocultar
            }
        }
        function createPlaylist() {
            const playlistNameInput = document.getElementById('new-list-name');
            const playlistName = playlistNameInput.value.trim();

            if (!playlistName) {
                alert("Por favor, introduce un nombre para la lista.");
                return;
            }

            // Enviar datos al endpoint de Django usando AJAX POST
            fetch('{% url "create-playlist" %}', { // Usaremos este nombre de URL en urls.py
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Importante: Necesitas el CSRF token para peticiones POST en Django
                    'X-CSRFToken': getCookie('csrftoken'), 
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ name: playlistName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    //alert(`Lista "${playlistName}" creada con éxito.`);
                    toggleNewListForm(); // Oculta el formulario después del éxito
                    
                    // Opcional: Reiniciar la vista para mostrar la nueva lista inmediatamente
                    // Esto recargará todos los tiles desde el backend
                    currentSearchTerm = ''; // Reseteamos el término de búsqueda si es necesario
                    nextPage = 1;
                    container.innerHTML = '';
                    loadPlaylists(); 

                } else {
                    alert('Error al crear la playlist: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Ocurrió un error de red o del servidor.');
            });
        }
        
        // Función auxiliar para obtener el CSRF token de las cookies (necesario para POST)
        
</script>
{% endblock %}

{% block search %}
    <input type="text" id="searchInput" class="searchInput" placeholder="Filtrar...">
{% endblock %}

{% block content-title %}Tu Biblioteca{% endblock %}


{% block content %}
<div id="loading" style="display: none;">Cargando playlists...</div>
<p></p>
<h2 class="section">{% fa5_icon "list" color="var(--accent-color)" %}&nbsp;Listas</h2>
<div class="tile-container" style="display: flex; gap: 20px; margin-top: 16px; margin-bottom: 32px;" id="tileContainer"></div>
<h2 class="section">{% fa5_icon "heart" color="var(--accent-color)" %}&nbsp;Favoritos</h2>
{% include 'main/song-list.html' with data=favorites %}
<h2 class="section">{% fa5_icon "random" color="var(--accent-color)" %}&nbsp;Selección Aleatoria</h2>
{% include 'main/song-list.html' with data=songs %}

<script>
    const container         = document.getElementById('tileContainer');
    const scrollbox         = document.getElementsByClassName('main-content')[0];
    const loadingIndicator  = document.getElementById('loading');
    const countDisplay      = document.getElementById('playlist-count');
    const searchInput       = document.getElementById('searchInput'); 

    window.addEventListener('DOMContentLoaded', (event) => {
        
        searchInput.addEventListener('input', () => {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(triggerSearch, 300);
        });

        triggerSearch(); 
    });
</script>

{% endblock %}
