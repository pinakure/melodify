<!-- templates/app/album_tiles.html -->

{% extends 'base.html' %} 

{% block header %}
<style>
    .tile-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        padding: 20px 0; /* Ajustado el padding superior */
    }

    .tile-item {
        border: none;
        border-radius: 8px;
        overflow: hidden;
        /* box-shadow: 0 4px 6px rgba(0,0,0,0.1); */
        transition: transform 0.2s;
        text-align: center;
    }

    .tile-item:hover {
        /* transform: translateY(-5px); */
    } 

    .tile-item img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        display: block;
    }

    .album-image {
        background: var(--bg-sidebar);
        background-size: cover;
    }

    .tile-info {
        padding-left: 15px;
        padding-right: 15px;
        padding-bottom: 10px;
        background-color: var(--bg-content);
    }

    .tile-info p {
        margin: 0;
        color: var(--tile-info-text);
        font-size: 0.9em;
    }

    /* Album Name (fixed height) */
    h3.album-name {
        margin: 0 0 5px 0;
        font-size: 16px !important;   
        padding-bottom: 8px;
        height: 18px;
        overflow: hidden;
    }

    .tile-item a {
        text-decoration: none;
        color: inherit;
        display: block;
    }
</style>

   
 <script>
        let nextPage = 1;
        let isLoading = false;
        let albumCount = 0;
        let currentSearchTerm = '-'; // Variable para guardar el t칠rmino de b칰squeda actual
        
        function loadPlaylists() {
            if (isLoading) return;
            isLoading = true;
            loadingIndicator.style.display = 'block';

            // Construimos la URL con par치metros de p치gina Y b칰squeda
            const url = new URL(`{% url 'album-tiles' %}`, window.location.origin);
            url.searchParams.set('page', nextPage);
            if (currentSearchTerm) {
                url.searchParams.set('search', currentSearchTerm);
            }

            fetch(url.toString(), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.albums.length > 0) {
                    data.albums.forEach(album => {
                        const div = document.createElement('div');
                        div.className = "tile-item album-item";
                        div.setAttribute('data-album-artist', album.safeartist); 
                        div.setAttribute('data-album-name', album.safename);
                        
                        div.innerHTML = `
                            <a href="${album.url_detalle}"> 
                                <div class="album-art">
                                    <div class="album-image" style="background-image: url('${album.url_picture ? album.url_picture : ''}')" alt="Album cover"></div>
                                </div>
                                <div class="tile-info">
                                    <h3 class="album-name">${album.nombre}</h3>
                                    <h6>${album.artist}</h6>
                                </div>
                            </a>
                        `;
                        container.appendChild(div);
                    });
                    nextPage++;
                    isLoading = false;
                    // Actualizamos el contador total si la respuesta lo incluye
                    if (data.total_count !== undefined) {
                         albumCount = data.total_count;
                         countDisplay.textContent = albumCount;
                    }
                } else {
                    window.removeEventListener('scroll', handleScroll);
                }
                loadingIndicator.style.display = 'none';
            })
            .catch(error => {
                console.error('Error fetching albums:', error);
                isLoading = false;
                loadingIndicator.style.display = 'none';
            });
        }
        
        // ... handleScroll function remains the same ...
        function handleScroll() {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            if (scrollTop + clientHeight >= scrollHeight - 200) {
                loadPlaylists();
            }
        }

        // --- L칩gica de B칰squeda Integrada ---
        function triggerSearch() {
            const newSearchTerm = searchInput.value.toLowerCase().trim();
            
            if (newSearchTerm !== currentSearchTerm) {
                // Reiniciar el estado para una nueva b칰squeda
                currentSearchTerm = newSearchTerm;
                nextPage = 1;
                albumCount = 0;
                container.innerHTML = ''; // Limpiar 치lbumes anteriores
                scrollbox.addEventListener('scroll', handleScroll); // Asegurarse de que el scroll listener est칠 activo
                loadPlaylists(); // Cargar la primera p치gina de los resultados de la b칰squeda
                // La funci칩n filterAlbums() local ya no es necesaria si todo se hace por backend AJAX
            }
        }
    </script>
{% endblock %}

{% block search %}
    <input type="text" id="searchInput" class="searchInput" placeholder="Filtrar 치lbumes...">
    <!-- <input type="text" id="searchInput" class="searchInput" placeholder="Filtrar 치lbumes..." onkeyup="filterAlbums()"> -->
{% endblock %}

{% block content-title %}츼lbumes (<span id="album-count">{{ albums.count }}</span>){% endblock %}


{% block content %}

<!-- Un elemento de "carga" o "spinner" -->
<div id="loading" style="display: none;">Cargando m치s playlists...</div>

<div class="tile-container" id="tileContainer">
    <!-- {% for album in albums %}
        <div class="tile-item album-item" data-album-artist="{% if album.artists.all.count > 3 %}various Artists{% else %}{% for artist in album.artists.all %}{{artist.name | lower }} {% endfor %}{% endif %}" data-album-name="{{ album.name|lower }}">
            <a href="{% url 'album-detail' album.pk %}">
                <div class="album-art">
                    {% if album.picture %}
                        <div class="album-image" style="background-image: url('{{ album.picture }}')" alt="{{ album.name }} cover"></div>
                    {% else %}
                        <div class="placeholder-image">游</div>
                    {% endif %}
                </div>
                <div class="tile-info">
                    <h3 class="album-name">{{ album.name }}</h3>
                    {% if album.artists.all.count > 3 %}
                        <p>Various Artists</p>
                    {% else %}
                        {% for artist in album.artists.all %}
                        <p>
                            {{artist.name}}
                        </p>
                        {% endfor %}
                    {% endif %}
                </div>
            </a>
        </div>
    {% empty %}
        <p id="no-albums-message">No se encontraron 치lbumes.</p>
    {% endfor %} -->
</div>

<!-- Scripts de JavaScript para el filtrado -->
<script>

    const container = document.getElementById('tileContainer');
    const scrollbox = document.getElementsByClassName('main-content')[0];
    const loadingIndicator = document.getElementById('loading');
    const countDisplay = document.getElementById('album-count');
    const searchInput = document.getElementById('searchInput'); // Referencia al input

    // Carga inicial y listeners
    window.addEventListener('DOMContentLoaded', (event) => {
        scrollbox.addEventListener('scroll', handleScroll);
        
        // Reemplazamos el onkeyup del HTML por un event listener aqu칤
        // Usamos 'input' para una respuesta m치s r치pida que 'change' o 'keyup'
        searchInput.addEventListener('input', () => {
            // Usamos un peque침o retardo (debounce) para no saturar el servidor con peticiones
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(triggerSearch, 300);
        });

        // Cargar la primera p치gina (vac칤a si el input de b칰squeda ya tiene algo al cargar)
        triggerSearch(); 
    });


    function filterAlbums() {
        // Obtener el valor de b칰squeda y convertirlo a min칰sculas
        const input = document.getElementById('searchInput');
        const counter = document.getElementById('album-count');
        const filter = input.value.toLowerCase();
        
        // Obtener todos los elementos de la lista de 치lbumes
        const albumCards = document.querySelectorAll('.album-item');
        const noAlbumsMessage = document.getElementById('no-albums-message');
        
        let found = false;
        let count = 0;
        // Iterar sobre todas las tarjetas y ocultar las que no coinciden
        albumCards.forEach(card => {
            const name = card.getAttribute('data-album-name').toLowerCase();
            const artist = card.getAttribute('data-album-artist').toLowerCase();
            
            if (name.includes(filter) ||artist.includes(filter)) {
                card.style.display = ""; // Mostrar el elemento (default block/grid item)
                found = true;
                count++;
            } else {
                card.style.display = "none"; // Ocultar el elemento
            }
        });
        counter.innerHTML = count;
        // Manejar el mensaje de "no encontrados" si es necesario
        if (noAlbumsMessage) {
            noAlbumsMessage.style.display = found ? "none" : "";
        }
    }
</script>

{% endblock %}
